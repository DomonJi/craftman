#!/bin/sh
set -e
PLUGIN_NAME="mysql"
MYSQL__DATABASE_NAME="craft"

mysql__usage()
{
  echo " $SELF mysql:run             Open mysql client or run a command on MySQL docker container"
  echo " $SELF mysql:backup          Create a backup at ${BACKUP_DIR}/"
  echo " $SELF mysql:restore <file>  Restore a backup from <file> (.sql.gz) to MySQL database"
}

mysql__run()
{
  CMD="${@:-TERM=dumb mysql $MYSQL__DATABASE_NAME}"
  docker exec -i -t "$(__mysql_container)" sh -i -c "$CMD"
}

mysql__backup()
{
  mkdir -p "$BACKUP_PATH"
  MYSQL__BACKUP_FILE="$BACKUP_PATH/${NAME}_$(date +%Y-%m-%d_%H-%M)"
  cm_log "Dumping from MySQL"
  mysql__run mysqldump craft > "$MYSQL__BACKUP_FILE.sql"
  mysql_backup_hook "$MYSQL__BACKUP_FILE.sql"
  cm_log "Gziping backup file"
  gzip -f "$MYSQL__BACKUP_FILE.sql"
  cm_log "Backup file created at $MYSQL__BACKUP_FILE.sql.gz"
}

mysql__restore()
{
  [ "$1" = "" ] && abort "File is required <file.sql.gz>"
  cm_log "Restoring backup $1"
  MYSQL__RESTORE_NAME="$(basename "$1").sql"
  MYSQL__RESTORE_FILE="/tmp/$MYSQL__RESTORE_NAME"
  gzip -d -c "$1" > "$MYSQL__RESTORE_FILE"
  mysql_restore_hook "$MYSQL__RESTORE_FILE"
  cm_log "Copy backup file to container /tmp"
  docker cp "$MYSQL__RESTORE_FILE" "$(__mysql_container):/tmp"
  cm_log "Import backup file to MySQL"
  mysql__run "mysql craft -e 'source $MYSQL__RESTORE_FILE'"
  cm_log "Removing all temporary files"
  rm -f  "$MYSQL__RESTORE_FILE"
  mysql__run "rm -f $MYSQL__RESTORE_FILE"
  cm_log "Backup restore completed"
}

__mysql_container()
{
  docker_compose ps | grep mysqld | cut -f 1 -d ' '
}

# Hook for process sql backup file
mysql_backup_hook()
{
  :
}

# Hook for process sql backup file
mysql_restore_hook()
{
  :
}
